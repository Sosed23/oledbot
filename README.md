# Telegram –±–æ—Ç –¥–ª—è –∑–∞–∫–∞–∑–∞ –∑–∞–ø–∞—Å–Ω—ã—Ö —á–∞—Å—Ç–µ–π –¥–ª—è OLED –¥–∏—Å–ø–ª–µ–µ–≤

–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π Telegram –±–æ—Ç–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ –∑–∞–ø–∞—Å–Ω—ã—Ö —á–∞—Å—Ç–µ–π –¥–ª—è OLED –¥–∏—Å–ø–ª–µ–µ–≤, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ **Aiogram 3**, **SQLAlchemy** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ **Alembic** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏.

–î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–¥–æ–±–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ loguru. –ë–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –ª–æ–≥–∏ –∫—Ä–∞—Å–∏–≤–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –∏ —Ñ–æ–Ω–æ–º –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª –ª–æ–≥–æ–≤.

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Telegram API**: Aiogram 3
- **ORM**: SQLAlchemy —Å asyncpg
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL
- **–°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π**: Alembic

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ü—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏ –ª—É—á—à–∏–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏ FastAPI. –ö–∞–∂–¥—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –±–æ—Ç–∞ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –º–∏–Ω–∏-—Å–µ—Ä–≤–∏—Å, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ migration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ versions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ env.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README
‚îÇ   ‚îú‚îÄ‚îÄ dao/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base.py
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dao.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.py
‚îÇ   ‚îú‚îÄ‚îÄ stocks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dao.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ group_router.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers_back_cover.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers_crash_display.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers_production.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers_re_gluing.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers_spare_parts.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models_cart.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models_order.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router_aiagent.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router_cart.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router_order.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ router_product.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router_search.py
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ ai_agent.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îú‚îÄ‚îÄ database.py
‚îÇ   ‚îú‚îÄ‚îÄ log.txt
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ operations.py
‚îÇ   ‚îú‚îÄ‚îÄ planfix.py
‚îÇ   ‚îú‚îÄ‚îÄ planfix_order.py
‚îÇ   ‚îî‚îÄ‚îÄ webhook.py
‚îú‚îÄ‚îÄ alembic.ini
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–∏–Ω–∏-—Å–µ—Ä–≤–∏—Å–∞

–ö–∞–∂–¥—ã–π –º–∏–Ω–∏-—Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

- **keyboards/**: –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã Telegram (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏ –∏–Ω–ª–∞–π–Ω)
- **dao.py**: –û–±—ä–µ–∫—Ç—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ SQLAlchemy
- **models.py**: –ú–æ–¥–µ–ª–∏ SQLAlchemy, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞
- **router.py**: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Aiogram –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
BOT_TOKEN=your_bot_token_here
ADMIN_IDS=[12345,344334]
PLANFIX_TOKEN=your_planfix_token
PLANFIX_URL_REST=https://yourcompany.planfix.ru/rest/
N8N_AIAGENT_WEBHOOK=https://your-n8n-webhook-url
TARGET_CHAT_ID=your_target_chat_id
DB_HOST=localhost
DB_PORT=5432
DB_NAME=your_database_name
DB_USER=your_database_user
DB_PASS=your_database_password
```

- `BOT_TOKEN`: –ü–æ–ª—É—á–∏—Ç–µ —É [BotFather](https://t.me/BotFather)
- `ADMIN_IDS`: –°–ø–∏—Å–æ–∫ Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –±–æ—Ç–∞. –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç—É—Ç –ü–æ–ª—É—á–∏—Ç–µ —É [IDBot Finder Pro](https://t.me/get_tg_ids_universeBOT)
- `PLANFIX_TOKEN`: –¢–æ–∫–µ–Ω API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Planfix
- `PLANFIX_URL_REST`: URL REST API Planfix
- `N8N_AIAGENT_WEBHOOK`: URL –≤–µ–±—Ö—É–∫–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å n8n AI Agent
- `TARGET_CHAT_ID`: ID —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `DB_HOST`: –•–æ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- `DB_PORT`: –ü–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- `DB_NAME`: –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `DB_USER`: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `DB_PASS`: –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```
aiofiles==24.1.0
aiogram==3.19.0
aiohappyeyeballs==2.4.4
aiohttp==3.10.11
aiosignal==1.3.2
aiosqlite==0.20.0
alembic==1.13.3
annotated-types==0.7.0
anyio==4.9.0
asyncpg==0.30.0
attrs==25.1.0
beautifulsoup4==4.13.3
certifi==2024.12.14
charset-normalizer==3.4.1
click==8.1.8
colorama==0.4.6
fastapi==0.115.12
frozenlist==1.5.0
greenlet==3.1.1
h11==0.14.0
httpcore==1.0.7
httpx==0.28.1
idna==3.10
loguru==0.7.2
magic-filter==1.0.12
Mako==1.3.8
MarkupSafe==3.0.2
multidict==6.1.0
propcache==0.2.1
psycopg2-binary==2.9.10
pydantic==2.9.2
pydantic-settings==2.5.2
pydantic_core==2.23.4
python-dotenv==1.0.1
redis==5.2.1
requests==2.32.3
sniffio==1.3.1
soupsieve==2.6
SQLAlchemy==2.0.37
starlette==0.46.1
typing_extensions==4.12.2
urllib3==2.3.0
uvicorn==0.34.0
win32_setctime==1.2.0
yarl==1.18.3
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ–ª–∏

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å SQLAlchemy —Å –æ–±—â–∏–º–∏ –ø–æ–ª—è–º–∏:

```python
class Base(AsyncAttrs, DeclarativeBase):
    __abstract__ = True  # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –±—É–¥–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –Ω–µ–≥–æ

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)

    created_at: Mapped[datetime] = mapped_column(
        TIMESTAMP,
        server_default=func.now()
    )
    updated_at: Mapped[datetime] = mapped_column(
        TIMESTAMP,
        server_default=func.now(),
        onupdate=func.now()
    )

    @classmethod
    @property
    def __tablename__(cls) -> str:
        return cls.__name__.lower() + 's'

    def to_dict(self) -> dict:
        # –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä—å
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}
```

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å SQLAlchemy —Å –æ–±—â–∏–º–∏ –ø–æ–ª—è–º–∏:

```python
class Base(AsyncAttrs, DeclarativeBase):
    __abstract__ = True  # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –±—É–¥–µ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –Ω–µ–≥–æ

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)

    created_at: Mapped[datetime] = mapped_column(
        TIMESTAMP,
        server_default=func.now()
    )
    updated_at: Mapped[datetime] = mapped_column(
        TIMESTAMP,
        server_default=func.now(),
        onupdate=func.now()
    )

    return cls.__name__.lower() + 's'

    def to_dict(self) -> dict:
        # –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä—å
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}
```

### –û–±—ä–µ–∫—Ç—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º (DAO)
```

### –û–±—ä–µ–∫—Ç—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º (DAO)

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å BaseDAO —Å –æ–±—â–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

- `find_one_or_none_by_id` - –ø–æ–∏—Å–∫ –ø–æ ID
- `find_one_or_none` - –ø–æ–∏—Å–∫ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
- `find_all` - –ø–æ–∏—Å–∫ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
- `add` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
- `add_many` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π
- `update` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- `delete` - —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
- `count` - –ø–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
- `paginate` - –ø–∞–≥–∏–Ω–∞—Ü–∏—è
- `find_by_ids` - –ø–æ–∏—Å–∫ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º ID
- `upsert` - —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
- `bulk_update` - –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

–°–µ—Ä–≤–∏—Å-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ DAO –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç BaseDAO:

```python
from bot.dao.base import BaseDAO
from bot.users.models import User

class UserDAO(BaseDAO):
    model = User
```

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```python
user_info = await UserDAO.find_one_or_none(telegram_id=user_id)

await UserDAO.add(
    telegram_id=user_id,
    username=message.from_user.username,
    first_name=message.from_user.first_name,
    last_name=message.from_user.last_name,
    referral_id=ref_id
)
```

–í –ø—Ä–æ–µ–∫—Ç–µ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è DAO –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥—Ä—É–≥–∏–º–∏ —Å—É—â–Ω–æ—Å—Ç—è–º–∏:
- `Cart` - –∫–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `Order` - –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `OrderItem` - —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–∫–∞–∑–æ–≤
- `OrderStatusHistory` - –∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤
- `Model` - –º–æ–¥–µ–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

## –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à–∏ –º–æ–¥–µ–ª–∏
2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –º–æ–¥–µ–ª–∏ –≤ `migration/env.py`
3. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
alembic revision --autogenerate -m "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
```
4. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
alembic upgrade head
```

## –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª

–í –∫–æ—Ä–Ω–µ –ø–∞–ø–∫–∏ bot –µ—Å—Ç—å —Ñ–∞–π–ª `main.py`. –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Ç–µ–ª–µ–≥—Ä–∞–º–º –±–æ—Ç–∞. –í —ç—Ç–æ—Ç —Ñ–∞–π–ª –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è —Ä–æ—É—Ç–µ—Ä—ã, –ø—Ä–æ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞, –ø—Ä–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ª–æ–≥–∏ –∏ –ø—Ä–æ—á–µ–µ. –¢–∞–∫–∂–µ –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã middleware –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Planfix –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram-–≥—Ä—É–ø–ø—É.

```python
import asyncio
from contextlib import asynccontextmanager
import uvicorn
from aiogram import types
from aiogram.filters import Command
from aiogram.types import BotCommand, BotCommandScopeDefault
from aiogram.dispatcher.middlewares.base import BaseMiddleware
from loguru import logger
import re

from bot.config import bot, admins, dp, target_chat_id
from bot.users.router import user_router
from bot.stocks.router_product import product_router
from bot.stocks.router_cart import cart_router
from bot.stocks.router_search import search_router
from bot.stocks.router_order import order_router
from bot.stocks.router_aiagent import aiagent_router
from bot.stocks.group_router import group_router
from bot.webhook import app as fastapi_app  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º FastAPI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
from bot.planfix import add_incoming_comment_to_chat, add_outgoing_comment_to_chat
from bot.users.dao import UserDAO

# Middleware –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –±–æ—Ç—É)
class ForwardIncomingMessageMiddleware(BaseMiddleware):
    async def __call__(self, handler, event: types.Message, data: dict):
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è middleware –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        # ...

# Middleware –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—Ç –±–æ—Ç–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é) –≤ Planfix –∏ Telegram-–≥—Ä—É–ø–ø—É
class ForwardOutgoingMessageMiddleware(BaseMiddleware):
    async def __call__(self, handler, event, data: dict):
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è middleware –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        # ...

# –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–µ –º–µ–Ω—é
async def set_commands():
    commands = [BotCommand(command='start', description='–°—Ç–∞—Ä—Ç')]
    await bot.set_my_commands(commands, BotCommandScopeDefault())

# –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∫–æ–≥–¥–∞ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
async def start_bot():
    await set_commands()
    for admin_id in admins:
        try:
            await bot.send_message(admin_id, f'–Ø –∑–∞–ø—É—â–µ–Ωü•≥.')
        except:
            pass
    logger.info("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω.")

# –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∫–æ–≥–¥–∞ –±–æ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É
async def stop_bot():
    try:
        for admin_id in admins:
            await bot.send_message(admin_id, '–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ó–∞ —á—Ç–æ?üòî')
    except:
        pass
    logger.error("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏ FastAPI
async def run_all():
    # –ó–∞–ø—É—Å–∫–∞–µ–º polling –¥–ª—è –±–æ—Ç–∞
    logger.info("Starting bot polling...")
    bot_task = asyncio.create_task(dp.start_polling(bot, allowed_updates=dp.resolve_used_update_types()))

    # –ó–∞–ø—É—Å–∫–∞–µ–º FastAPI-—Å–µ—Ä–≤–µ—Ä
    logger.info("Starting FastAPI server...")
    config = uvicorn.Config(fastapi_app, host="0.0.0.0", port=8000, log_level="info")
    server = uvicorn.Server(config)
    fastapi_task = asyncio.create_task(server.serve())

    # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–µ–∏—Ö –∑–∞–¥–∞—á
    await asyncio.gather(bot_task, fastapi_task)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–æ—É—Ç–µ—Ä–æ–≤ –∏ middleware
def setup_bot():
    dp.message.middleware(ForwardIncomingMessageMiddleware())
    dp.message.outer_middleware(ForwardOutgoingMessageMiddleware())
    dp.callback_query.outer_middleware(ForwardOutgoingMessageMiddleware())

    dp.include_router(user_router)
    dp.include_router(product_router)
    dp.include_router(cart_router)
    dp.include_router(search_router)
    dp.include_router(order_router)
    dp.include_router(aiagent_router)
    dp.include_router(group_router)

    dp.startup.register(start_bot)
    dp.shutdown.register(stop_bot)

if __name__ == "__main__":
    setup_bot()
    asyncio.run(run_all())
```

–û—Å–Ω–æ–≤–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ middleware –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Planfix –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram-–≥—Ä—É–ø–ø—É
2. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ FastAPI –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (n8n AI Agent)
3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –±–æ—Ç–∞

## –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
```bash
git clone <url-to-your-repository> .
```

2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```

3. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–º. —Ä–∞–∑–¥–µ–ª "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è")

4. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
```bash
alembic upgrade head
```

5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:
```bash
python -m bot.main
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤, —Ñ–æ–∫—É—Å–∏—Ä—É—è—Å—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ BaseDAO –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –°–ª–µ–¥—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Alembic –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

---

